{% extends "base.html" %}
{% block content %}
{% set active = "config" %}
{% set title = "Configuration" %}

<div class="mb-8 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-gray-800">Bot Configuration</h1>
    <div class="flex gap-3">
        <button onclick="resetConfig()" class="px-4 py-2 text-red-600 bg-red-50 rounded-lg hover:bg-red-100 transition-colors">
            Reset Defaults
        </button>
        <button onclick="saveConfig()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
            Save Changes
        </button>
    </div>
</div>

<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
    <form id="configForm" class="space-y-8">
        <!-- Trading Settings -->
        <div>
            <h3 class="text-lg font-medium text-gray-900 mb-4">Trading Settings</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Timeframe (minutes)
                    </label>
                    <input type="number" name="timeframe" value="{{ config.timeframe }}" 
                           class="w-full p-2 border rounded" min="1" max="60">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Max Trades Per Day
                    </label>
                    <input type="number" name="maxTradesPerDay" value="{{ config.maxTradesPerDay }}" 
                           class="w-full p-2 border rounded" min="1" max="100">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Stop Loss (%)
                    </label>
                    <input type="number" step="0.1" name="stopLoss" value="{{ config.stopLoss }}" 
                           class="w-full p-2 border rounded" min="0.1" max="10">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Take Profit (%)
                    </label>
                    <input type="number" step="0.1" name="takeProfit" value="{{ config.takeProfit }}" 
                           class="w-full p-2 border rounded" min="0.5" max="20">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Trade Allocation (%)
                    </label>
                    <input type="number" name="tradeAllocation" value="{{ config.tradeAllocation }}" 
                           class="w-full p-2 border rounded" min="1" max="100" readonly>
                    <p class="text-xs text-gray-500 mt-1">Fixed at 100% (uses entire balance)</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Minimum Trade ($)
                    </label>
                    <input type="number" step="0.01" name="minTradeAmount" value="{{ config.minTradeAmount }}" 
                           class="w-full p-2 border rounded" min="5" max="1000" readonly>
                    <p class="text-xs text-gray-500 mt-1">Minimum $5 required</p>
                </div>
            </div>
        </div>

        <!-- AI Settings -->
        <div>
            <h3 class="text-lg font-medium text-gray-900 mb-4">AI Settings</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    AI Coins (10 coins under $1)
                </label>
                <textarea name="ai_coins" rows="3" 
                          class="w-full p-2 border rounded font-mono text-sm"
                          placeholder="Enter symbols like ADAUSDT, DOGEUSDT...">{{ config.ai_coins|join(', ') }}</textarea>
                <p class="text-xs text-gray-500 mt-1">Comma-separated list of 10 coin symbols</p>
            </div>
            <button type="button" onclick="updateAICoins()" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                Update AI Coins Now
            </button>
        </div>

        <!-- Risk Settings -->
        <div>
            <h3 class="text-lg font-medium text-gray-900 mb-4">Risk Settings</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Max Hold Time (seconds)
                    </label>
                    <input type="number" name="maxHold" value="{{ config.maxHold }}" 
                           class="w-full p-2 border rounded" min="60" max="86400">
                    <p class="text-xs text-gray-500 mt-1">{{ config.maxHold//60 }} minutes</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Scan Interval (seconds)
                    </label>
                    <input type="number" name="scanInterval" value="{{ config.scanInterval }}" 
                           class="w-full p-2 border rounded" min="10" max="300">
                </div>
            </div>
        </div>

        <!-- System Settings -->
        <div>
            <h3 class="text-lg font-medium text-gray-900 mb-4">System Settings</h3>
            <div class="space-y-4">
                <div class="flex items-center">
                    <input type="checkbox" name="dryRun" id="dryRun" 
                           {% if config.dryRun %}checked{% endif %}
                           class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                    <label for="dryRun" class="ml-2 text-sm text-gray-900">
                        Dry Run (Paper Trading) - No real orders
                    </label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" name="testOnTestnet" id="testnet" 
                           {% if config.testOnTestnet %}checked{% endif %}
                           class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                    <label for="testnet" class="ml-2 text-sm text-gray-900">
                        Use Testnet
                    </label>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
async function saveConfig() {
    const form = document.getElementById('configForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    // Handle checkboxes
    data.dryRun = document.getElementById('dryRun').checked;
    data.testOnTestnet = document.getElementById('testnet').checked;
    
    // Parse AI coins
    if (data.ai_coins) {
        data.ai_coins = data.ai_coins.split(',').map(s => s.trim()).filter(s => s);
    }
    
    // Convert numbers
    const numberFields = ['timeframe', 'maxTradesPerDay', 'stopLoss', 'takeProfit', 
                         'tradeAllocation', 'minTradeAmount', 'maxHold', 'scanInterval'];
    numberFields.forEach(field => {
        if (data[field]) data[field] = Number(data[field]);
    });
    
    try {
        const res = await fetch('/api/config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        if (res.ok) {
            alert('Configuration saved!');
            window.location.reload();
        } else {
            alert('Error saving configuration');
        }
    } catch (e) {
        alert('Failed to save configuration');
    }
}

async function resetConfig() {
    if (!confirm('Reset all settings to defaults?')) return;
    
    try {
        const res = await fetch('/api/config/reset', {method: 'POST'});
        if (res.ok) {
            alert('Configuration reset to defaults');
            window.location.reload();
        }
    } catch (e) {
        alert('Failed to reset configuration');
    }
}

async function updateAICoins() {
    if (!confirm('Update AI coins now? This will fetch new picks from Meta LLM.')) return;
    
    try {
        const res = await fetch('/api/ai/update', {method: 'POST'});
        const result = await res.json();
        
        if (result.success) {
            alert(`AI coins updated: ${result.coins.join(', ')}`);
        } else {
            alert('Failed to update AI coins');
        }
    } catch (e) {
        alert('Error updating AI coins');
    }
}
</script>
{% endblock %}
